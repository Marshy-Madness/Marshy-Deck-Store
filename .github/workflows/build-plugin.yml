name: Build Plugins (Submodules)

on:
  push:
    branches:
      - main
    paths:
      - "plugins/**"
      - ".github/workflows/build-plugins.yml"

  workflow_dispatch:

jobs:

  detect:
    runs-on: ubuntu-latest
    outputs:
      plugin_matrix: ${{ steps.detector.outputs.plugin_matrix }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Detect changed plugins
      id: detector
      run: |
        ALL=$(ls plugins)

        CHANGED=$(git diff --name-only HEAD~1 HEAD \
          | grep "^plugins/" \
          | cut -d/ -f2 \
          | uniq)

        if [ -z "$CHANGED" ]; then
          CHANGED=$ALL
        fi

        JSON=$(printf '%s\n' $CHANGED | jq -R . | jq -s .)

        echo "plugin_matrix=$JSON" >> $GITHUB_OUTPUT

  build:
    needs: detect
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        plugin: ${{ fromJSON(needs.detect.outputs.plugin_matrix) }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup PNPM
      uses: pnpm/action-setup@v3
      with:
        version: 9

    - name: Install Decky CLI
      run: |
        mkdir -p /tmp/decky
        curl -L -o /tmp/decky/decky \
        https://github.com/SteamDeckHomebrew/cli/releases/download/0.0.7/decky-linux-x86_64
        chmod +x /tmp/decky/decky
        echo "/tmp/decky" >> $GITHUB_PATH

    - name: Build plugin
      run: |
        mkdir -p output
        sudo decky plugin build -s directory -o /tmp/out plugins/${{ matrix.plugin }}
        sudo chown -R $USER:$USER /tmp/out
        mv /tmp/out/*.zip output/${{ matrix.plugin }}.zip

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.plugin }}
        path: output/${{ matrix.plugin }}.zip

  manifest:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Generate plugins.json
      run: |
        echo "[" > plugins.json
        first=true
        for plugin in plugins/*; do
          slug=$(basename "$plugin")
          meta="$plugin/plugin.json"

          name=$(jq -r '.name' "$meta")
          author=$(jq -r '.author' "$meta")
          description=$(jq -r '.description // "No description"' "$meta")
          version=$(jq -r '.version // "0.0.0"' "$meta")

          zipUrl="https://raw.githubusercontent.com/${{ github.repository }}/main/output/${slug}.zip"

          if [ "$first" = true ]; then
            first=false
          else
            echo "," >> plugins.json
          fi

          printf '  {\n' >> plugins.json
          printf '    "name": "%s",\n' "$name" >> plugins.json
          printf '    "slug": "%s",\n' "$slug" >> plugins.json
          printf '    "author": "%s",\n' "$author" >> plugins.json
          printf '    "description": "%s",\n' "$description" >> plugins.json
          printf '    "version": "%s",\n' "$version" >> plugins.json
          printf '    "zipUrl": "%s"\n' "$zipUrl" >> plugins.json
          printf '  }' >> plugins.json

        done
        echo "]" >> plugins.json

    - name: Commit updated manifest
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Update plugins.json"
        file_pattern: plugins.json
