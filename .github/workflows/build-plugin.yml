name: Build Plugins (Submodules)

on:
  push:
    branches:
      - main
    paths:
      - "plugins/**"
      - ".github/workflows/build-plugins.yml"

  workflow_dispatch:

jobs:

  # -------------------------
  # 1. DETECT CHANGED PLUGINS
  # -------------------------
  detect:
    runs-on: ubuntu-latest
    outputs:
      plugin_matrix: ${{ steps.detector.outputs.plugin_matrix }}

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Find Changed Plugins
      id: detector
      run: |
        # List all plugin folders
        ALL=$(ls plugins)

        # Find changed plugin folders based on commit diff
        CHANGED=$(git diff --name-only HEAD~1 HEAD | grep "^plugins/" | cut -d/ -f2 | uniq)

        # If first run or no changes, build everything
        if [ -z "$CHANGED" ]; then
          CHANGED=$ALL
        fi

        # Convert to JSON array
        JSON=$(printf '%s\n' $CHANGED | jq -R . | jq -s .)

        echo "plugin_matrix=$JSON" >> $GITHUB_OUTPUT

  # -------------------------
  # 2. BUILD EACH PLUGIN
  # -------------------------
  build:
    needs: detect
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        plugin: ${{ fromJSON(needs.detect.outputs.plugin_matrix) }}

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up PNPM
      uses: pnpm/action-setup@v3
      with:
        version: 9

    - name: Install Decky CLI
      run: |
        mkdir /tmp/decky-cli
        curl -L -o /tmp/decky-cli/decky \
          "https://github.com/SteamDeckHomebrew/cli/releases/download/0.0.7/decky-linux-x86_64"
        chmod +x /tmp/decky-cli/decky
        echo "/tmp/decky-cli" >> $GITHUB_PATH

    - name: Build Plugin
      run: |
        mkdir -p output
        sudo decky plugin build \
          -s directory \
          -o /tmp/out \
          plugins/${{ matrix.plugin }}
        sudo chown -R $USER:$USER /tmp/out
        mv /tmp/out/*.zip output/${{ matrix.plugin }}.zip

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.plugin }}
        path: output/${{ matrix.plugin }}.zip

  # -------------------------
  # 3. UPDATE plugins.json
  # -------------------------
  manifest:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Build plugins.json
      run: |
        echo "[" > plugins.json

        for plugin in plugins/*; do
          slug=$(basename "$plugin")
          meta="$plugin/plugin.json"

          name=$(jq -r '.name' $meta)
          author=$(jq -r '.author' $meta)
          description=$(jq -r '.description // "No description"' $meta)
          version=$(jq -r '.version // "0.0.0"' $meta)

          zipUrl="https://raw.githubusercontent.com/${{ github.repository }}/main/output/${slug}.zip"

          cat >> plugins.json <<EOF
  {
    "name": "$name",
    "slug": "$slug",
    "author": "$author",
    "description": "$description",
    "version": "$version",
    "zipUrl": "$zipUrl"
  },
EOF

        done

        # Remove trailing comma and close JSON array
        sed -i '$ s/,$//' plugins.json
        echo "]" >> plugins.json

    - name: Commit Updated Manifest
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Update plugins.json"
        file_pattern: plugins.json
