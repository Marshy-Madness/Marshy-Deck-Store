name: Build Plugins (Submodules)

on:
  push:
    branches:
      - main
    paths:
      - "plugins/**"
      - ".github/workflows/build-plugins.yml"

  workflow_dispatch:

jobs:
  find:
    name: Detect changed plugins
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.out.outputs.matrix }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Determine changed plugin folders
      id: out
      run: |
        ALL=$(ls plugins)
        CHANGED=$(git diff --name-only HEAD~1 HEAD | grep "^plugins/" | cut -d/ -f2 | uniq)

        # On first build or no changes â€” rebuild ALL
        if [ -z "$CHANGED" ]; then
          CHANGED=$ALL
        fi

        JSON=$(printf '%s\n' $CHANGED | jq -R . | jq -s .)
        echo "matrix=$JSON" >> $GITHUB_OUTPUT

  build:
    name: Build plugin
    needs: find
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        plugin: ${{ fromJSON(needs.find.outputs.matrix) }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - uses: pnpm/action-setup@v3
      with:
        version: 9

    - name: Install Decky CLI
      run: |
        mkdir /tmp/decky-cli
        curl -L -o /tmp/decky-cli/decky \
          "https://github.com/SteamDeckHomebrew/cli/releases/download/0.0.7/decky-linux-x86_64"
        chmod +x /tmp/decky-cli/decky
        echo "/tmp/decky-cli" >> $GITHUB_PATH

    - name: Build plugin via Decky CLI
      run: |
        mkdir -p output
        sudo decky plugin build \
          -s directory \
          -o /tmp/out \
          plugins/${{ matrix.plugin }}

        sudo chown -R $USER:$USER /tmp/out
        mv /tmp/out/*.zip output/${{ matrix.plugin }}.zip

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.plugin }}
        path: output/${{ matrix.plugin }}.zip

  manifest:
    name: Update plugins.json
    needs: build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Generate plugin manifest
      run: |
        echo "[" > plugins.json

        for plugin in plugins/*; do
          slug=$(basename $plugin)
          meta="$plugin/plugin.json"

          name=$(jq -r '.name' $meta)
          author=$(jq -r '.author' $meta)
          description=$(jq -r '.description' $meta)
          version=$(jq -r '.version' $meta)

          zipUrl="https://raw.githubusercontent.com/${{ github.repository }}/main/output/${slug}.zip"

          cat >> plugins.json <<EOF
  {
    "name": "$name",
    "slug": "$slug",
    "author": "$author",
    "description": "$description",
    "version": "$version",
    "zipUrl": "$zipUrl"
  },
EOF
        done

        sed -i '$ s/,$//' plugins.json
        echo "]" >> plugins.json

    - name: Commit updated plugins.json
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Update plugin manifest"
        file_pattern: plugins.json
